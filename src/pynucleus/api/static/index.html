<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyNucleus - Chemical Engineering AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .dark-gradient-bg {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }
        
        .chat-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .typing-indicator { animation: pulse 1.5s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading-dots span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .dark .glass-morphism {
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 transition-colors duration-300" x-data="pyNucleusApp()">
    <!-- Main Container -->
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="gradient-bg dark:dark-gradient-bg text-white shadow-xl">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-atom text-3xl"></i>
                            <div>
                                <h1 class="text-3xl font-bold">PyNucleus</h1>
                                <p class="text-blue-100 text-sm">Chemical Engineering AI Assistant</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- System Status -->
                        <div class="flex items-center space-x-2 glass-morphism px-3 py-2 rounded-lg">
                            <div class="w-2 h-2 rounded-full" 
                                 :class="systemStatus.online ? 'bg-green-400 animate-pulse' : 'bg-red-400'"></div>
                            <span class="text-sm font-medium" x-text="systemStatus.online ? 'Online' : 'Offline'"></span>
                        </div>
                        
                        <!-- Theme Toggle -->
                        <button @click="toggleTheme()" 
                                class="glass-morphism p-2 rounded-lg hover:bg-white/20 transition-colors">
                            <i :class="darkMode ? 'fas fa-sun' : 'fas fa-moon'" class="text-lg"></i>
                        </button>
                        
                        <!-- Settings -->
                        <button @click="showSettings = !showSettings" 
                                class="glass-morphism p-2 rounded-lg hover:bg-white/20 transition-colors">
                            <i class="fas fa-cog text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 container mx-auto px-4 py-8 max-w-7xl">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Chat Interface -->
                <div class="lg:col-span-3">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 h-[600px] flex flex-col">
                        <!-- Chat Header -->
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750 rounded-t-xl">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-robot text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900 dark:text-white">AI Assistant</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Chemical Engineering Expert</p>
                                    </div>
                                </div>
                                <button @click="clearChat()" 
                                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Messages Container -->
                        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messages-container">
                            <!-- Welcome Message -->
                            <div class="chat-bubble flex items-start space-x-3" x-show="messages.length === 0">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-white text-sm"></i>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 max-w-md">
                                    <p class="text-gray-800 dark:text-gray-200">
                                        👋 Welcome to PyNucleus! I'm your chemical engineering AI assistant. 
                                        Ask me about processes, equipment, safety, or upload documents to expand my knowledge.
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Chat Messages -->
                            <template x-for="message in messages" :key="message.id">
                                <div class="chat-bubble flex items-start space-x-3" 
                                     :class="message.type === 'user' ? 'flex-row-reverse space-x-reverse' : ''">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"
                                         :class="message.type === 'user' ? 'bg-green-500' : 'bg-blue-500'">
                                        <i :class="message.type === 'user' ? 'fas fa-user' : 'fas fa-robot'" 
                                           class="text-white text-sm"></i>
                                    </div>
                                    <div class="max-w-3xl">
                                        <div class="rounded-lg p-4"
                                             :class="message.type === 'user' ? 'bg-green-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'">
                                            <p x-text="message.content" class="whitespace-pre-wrap"></p>
                                        </div>
                                        <div class="mt-2 flex items-center space-x-4 text-xs text-gray-500 dark:text-gray-400"
                                             x-show="message.metadata">
                                            <span x-show="message.metadata?.processing_time">
                                                <i class="fas fa-clock"></i>
                                                <span x-text="message.metadata?.processing_time + 's'"></span>
                                            </span>
                                            <span x-show="message.metadata?.source_count">
                                                <i class="fas fa-book"></i>
                                                <span x-text="message.metadata?.source_count + ' sources'"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Typing Indicator -->
                            <div class="chat-bubble flex items-start space-x-3 typing-indicator" x-show="isTyping">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-robot text-white text-sm"></i>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                    <div class="loading-dots flex space-x-1">
                                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-750 rounded-b-xl">
                            <div class="flex space-x-3">
                                <div class="flex-1">
                                    <textarea x-model="currentQuestion" 
                                              @keydown.enter.ctrl="askQuestion()"
                                              @keydown.enter.meta="askQuestion()"
                                              :disabled="isTyping"
                                              placeholder="Ask about chemical processes, equipment, safety, or anything else..."
                                              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                                              rows="2"></textarea>
                                </div>
                                <button @click="askQuestion()" 
                                        :disabled="!currentQuestion.trim() || isTyping"
                                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-colors flex items-center space-x-2 font-medium">
                                    <i class="fas fa-paper-plane"></i>
                                    <span>Send</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                Press Ctrl+Enter to send • Powered by PyNucleus RAG System
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- System Status Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                            System Status
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Database</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 rounded-full" 
                                         :class="systemStatus.database?.status === 'ready' ? 'bg-green-400' : 'bg-yellow-400'"></div>
                                    <span class="text-sm font-medium" x-text="systemStatus.database?.status || 'Unknown'"></span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Documents</span>
                                <span class="text-sm font-medium" x-text="systemStatus.database?.estimated_docs || 0"></span>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">DB Size</span>
                                <span class="text-sm font-medium" x-text="(systemStatus.database?.size_mb || 0) + ' MB'"></span>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Model</span>
                                <span class="text-sm font-medium" x-text="systemStatus.model?.id?.split('/').pop() || 'Unknown'"></span>
                            </div>
                        </div>
                        
                        <button @click="refreshStatus()" 
                                class="w-full mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center space-x-2">
                            <i class="fas fa-sync-alt" :class="{'animate-spin': refreshing}"></i>
                            <span>Refresh Status</span>
                        </button>
                    </div>
                    
                    <!-- Document Upload Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <i class="fas fa-cloud-upload-alt mr-2 text-green-500"></i>
                            Upload Documents
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center"
                                 @dragover.prevent @drop.prevent="handleFileDrop($event)">
                                <i class="fas fa-file-upload text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    Drag & drop files here or
                                </p>
                                <input type="file" 
                                       @change="handleFileSelect($event)" 
                                       accept=".txt,.pdf,.md,.doc,.docx"
                                       class="hidden" 
                                       id="file-input">
                                <label for="file-input" 
                                       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors">
                                    Choose Files
                                </label>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                    Supports: TXT, PDF, MD, DOC, DOCX
                                </p>
                            </div>
                            
                            <!-- Upload Progress -->
                            <div x-show="uploadProgress > 0" class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Uploading...</span>
                                    <span class="text-gray-600 dark:text-gray-400" x-text="uploadProgress + '%'"></span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                         :style="'width: ' + uploadProgress + '%'"></div>
                                </div>
                            </div>
                            
                            <!-- Recent Uploads -->
                            <div x-show="recentUploads.length > 0" class="space-y-2">
                                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Recent Uploads</h4>
                                <template x-for="upload in recentUploads" :key="upload.filename">
                                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-file-alt text-gray-400"></i>
                                            <span class="text-sm text-gray-700 dark:text-gray-300" x-text="upload.filename"></span>
                                        </div>
                                        <div class="w-2 h-2 rounded-full" 
                                             :class="upload.status === 'processed' ? 'bg-green-400' : 'bg-yellow-400'"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                            <i class="fas fa-lightning-bolt mr-2 text-yellow-500"></i>
                            Quick Actions
                        </h3>
                        
                        <div class="space-y-3">
                            <button @click="askPredefinedQuestion('What are the advantages of modular chemical plants?')"
                                    class="w-full text-left p-3 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                <i class="fas fa-industry mr-2 text-blue-500"></i>
                                <span class="text-sm">Modular Plants</span>
                            </button>
                            
                            <button @click="askPredefinedQuestion('How does distillation work in chemical processes?')"
                                    class="w-full text-left p-3 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                <i class="fas fa-flask mr-2 text-green-500"></i>
                                <span class="text-sm">Distillation Process</span>
                            </button>
                            
                            <button @click="askPredefinedQuestion('What are the key principles of process safety?')"
                                    class="w-full text-left p-3 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                <i class="fas fa-shield-alt mr-2 text-red-500"></i>
                                <span class="text-sm">Process Safety</span>
                            </button>
                            
                            <button @click="askPredefinedQuestion('How do heat exchangers improve energy efficiency?')"
                                    class="w-full text-left p-3 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                <i class="fas fa-thermometer-half mr-2 text-orange-500"></i>
                                <span class="text-sm">Heat Exchangers</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-6">
            <div class="container mx-auto px-4 text-center text-gray-600 dark:text-gray-400">
                <p>&copy; 2024 PyNucleus. Powered by advanced RAG technology and AI.</p>
            </div>
        </footer>
    </div>

    <script>
        function pyNucleusApp() {
            return {
                currentQuestion: '',
                messages: [],
                isTyping: false,
                darkMode: localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches),
                showSettings: false,
                theme: localStorage.getItem('theme') || 'auto',
                systemStatus: { online: false, database: null, model: null },
                refreshing: false,
                uploadProgress: 0,
                recentUploads: JSON.parse(localStorage.getItem('recentUploads') || '[]'),
                
                init() {
                    this.applyTheme();
                    this.refreshStatus();
                    this.loadMessages();
                    setInterval(() => { this.refreshStatus(); }, 30000);
                },
                
                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    this.theme = this.darkMode ? 'dark' : 'light';
                    localStorage.setItem('theme', this.theme);
                    this.applyTheme();
                },
                
                applyTheme() {
                    if (this.theme === 'dark' || (this.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                        document.documentElement.classList.add('dark');
                        this.darkMode = true;
                    } else {
                        document.documentElement.classList.remove('dark');
                        this.darkMode = false;
                    }
                },
                
                loadMessages() {
                    const saved = localStorage.getItem('chatMessages');
                    if (saved) { this.messages = JSON.parse(saved); }
                },
                
                saveMessages() {
                    localStorage.setItem('chatMessages', JSON.stringify(this.messages));
                },
                
                addMessage(type, content, metadata = null) {
                    this.messages.push({
                        id: Date.now(),
                        type, content, metadata,
                        timestamp: new Date()
                    });
                    this.saveMessages();
                    this.$nextTick(() => { this.scrollToBottom(); });
                },
                
                clearChat() {
                    this.messages = [];
                    this.saveMessages();
                },
                
                scrollToBottom() {
                    const container = document.getElementById('messages-container');
                    if (container) { container.scrollTop = container.scrollHeight; }
                },
                
                async refreshStatus() {
                    this.refreshing = true;
                    try {
                        const response = await fetch('/status');
                        if (response.ok) {
                            this.systemStatus = await response.json();
                            this.systemStatus.online = true;
                        } else {
                            this.systemStatus.online = false;
                        }
                    } catch (error) {
                        this.systemStatus.online = false;
                    } finally {
                        this.refreshing = false;
                    }
                },
                
                async askQuestion() {
                    if (!this.currentQuestion.trim() || this.isTyping) return;
                    
                    const question = this.currentQuestion.trim();
                    this.addMessage('user', question);
                    this.currentQuestion = '';
                    this.isTyping = true;
                    
                    try {
                        const response = await fetch('/ask', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ question })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.addMessage('assistant', data.answer, data.metadata);
                        } else {
                            this.addMessage('assistant', `Error: ${data.error}`);
                        }
                    } catch (error) {
                        this.addMessage('assistant', 'Sorry, I encountered an error processing your question. Please try again.');
                    } finally {
                        this.isTyping = false;
                    }
                },
                
                askPredefinedQuestion(question) {
                    this.currentQuestion = question;
                    this.askQuestion();
                },
                
                handleFileSelect(event) {
                    const files = event.target.files;
                    for (let file of files) { this.uploadFile(file); }
                },
                
                handleFileDrop(event) {
                    const files = event.dataTransfer.files;
                    for (let file of files) { this.uploadFile(file); }
                },
                
                async uploadFile(file) {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    this.uploadProgress = 0;
                    
                    try {
                        const progressInterval = setInterval(() => {
                            if (this.uploadProgress < 90) {
                                this.uploadProgress += Math.random() * 10;
                            }
                        }, 200);
                        
                        const response = await fetch('/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        clearInterval(progressInterval);
                        this.uploadProgress = 100;
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.recentUploads.unshift({
                                filename: file.name,
                                status: data.status,
                                timestamp: new Date()
                            });
                            this.recentUploads = this.recentUploads.slice(0, 5);
                            localStorage.setItem('recentUploads', JSON.stringify(this.recentUploads));
                            
                            this.addMessage('assistant', `✅ Successfully uploaded and processed "${file.name}". You can now ask questions about its content!`);
                            this.refreshStatus();
                        } else {
                            this.addMessage('assistant', `❌ Upload failed: ${data.error}`);
                        }
                    } catch (error) {
                        this.addMessage('assistant', `❌ Upload failed: ${error.message}`);
                    } finally {
                        setTimeout(() => { this.uploadProgress = 0; }, 2000);
                    }
                }
            }
        }
    </script>
</body>
</html>
