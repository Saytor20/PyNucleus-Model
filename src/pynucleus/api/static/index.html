<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyNucleus ▚ Developer Console</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        /* Old-computer terminal aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            color: #00ff41;
            font-family: 'Courier Prime', 'Courier New', monospace;
            line-height: 1.4;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* CRT screen effects */
        .crt::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%, 
                rgba(0, 0, 0, 0.25) 50%
            );
            background-size: 100% 2px;
            z-index: 1000;
            opacity: 0.1;
        }
        
        .crt::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(
                ellipse at center,
                rgba(0, 255, 65, 0.02) 0%,
                rgba(0, 0, 0, 0.1) 100%
            );
            z-index: 999;
        }
        
        /* Main container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid #00ff41;
            padding: 20px;
            background: rgba(0, 255, 65, 0.05);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ff41;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px #00ff41; }
            to { text-shadow: 0 0 20px #00ff41, 0 0 30px #00ff41; }
        }
        
        /* Mode tabs */
        .mode-tabs {
            display: flex;
            margin-bottom: 20px;
            border: 1px solid #00ff41;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .mode-tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: #00ff41;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            border-right: 1px solid #00ff41;
            transition: all 0.3s ease;
        }
        
        .mode-tab:last-child {
            border-right: none;
        }
        
        .mode-tab:hover {
            background: rgba(0, 255, 65, 0.1);
        }
        
        .mode-tab.active {
            background: #00ff41;
            color: #000;
            font-weight: bold;
        }
        
        /* Content panels */
        .panel {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Terminal-style boxes */
        .terminal-box {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff41;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier Prime', monospace;
        }
        
        .terminal-header {
            font-size: 1.2rem;
            color: #00ff41;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #00ff41;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .terminal-header::before {
            content: "▶";
            color: #ffaa00;
        }
        
        /* Form elements */
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            color: #00ff41;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-field {
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #ffaa00;
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.3);
        }
        
        .btn {
            background: transparent;
            border: 2px solid #00ff41;
            color: #00ff41;
            padding: 12px 24px;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #00ff41;
            color: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 255, 65, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            border-color: #ff4444;
            color: #ff4444;
        }
        
        .btn-danger:hover {
            background: #ff4444;
            color: #000;
        }
        
        .btn-warning {
            border-color: #ffaa00;
            color: #ffaa00;
        }
        
        .btn-warning:hover {
            background: #ffaa00;
            color: #000;
        }
        
        /* Output areas */
        .output-area {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00ff41;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier Prime', monospace;
            margin-top: 15px;
        }
        
        .output-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .output-area::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .output-area::-webkit-scrollbar-thumb {
            background: #00ff41;
            border-radius: 4px;
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-online {
            background: #00ff41;
        }
        
        .status-warning {
            background: #ffaa00;
        }
        
        .status-error {
            background: #ff4444;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Drag and drop upload */
        .upload-zone {
            border: 2px dashed #00ff41;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: rgba(0, 255, 65, 0.02);
        }
        
        .upload-zone.drag-over {
            border-color: #ffaa00;
            background: rgba(255, 170, 0, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 15px 30px;
            border: 2px solid #00ff41;
            color: #00ff41;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .file-label:hover {
            background: #00ff41;
            color: #000;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Progress bar */
        .progress-container {
            margin: 15px 0;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff41;
            height: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff41, #00cc33);
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-weight: bold;
            z-index: 1;
        }
        
        .progress-details {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #00ff41;
        }
        
        .progress-speed {
            color: #ffaa00;
            font-weight: bold;
        }
        
        .progress-file-info {
            margin-top: 5px;
            text-align: center;
            font-size: 0.8rem;
            color: #00cc33;
        }
        
        /* Real-time diagnostics */
        .diagnostics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .diagnostic-card {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            padding: 20px;
        }
        
        .diagnostic-title {
            color: #ffaa00;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .diagnostic-value {
            font-size: 1.5rem;
            color: #00ff41;
            margin-bottom: 5px;
        }
        
        .diagnostic-desc {
            color: #888;
            font-size: 0.9rem;
        }
        
        /* Loading states */
        .loading {
            display: none;
            color: #ffaa00;
            margin: 10px 0;
        }
        
        .loading.active {
            display: block;
        }
        
        .loading::after {
            content: "...";
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60% { content: "..."; }
            80%, 100% { content: ""; }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .mode-tabs {
                flex-direction: column;
            }
            
            .mode-tab {
                border-right: none;
                border-bottom: 1px solid #00ff41;
            }
            
            .mode-tab:last-child {
                border-bottom: none;
            }
            
            .diagnostics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Hidden utility class */
        .hidden {
            display: none !important;
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* HTMX indicators */
        .htmx-indicator {
            display: none;
        }
        
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        
        .htmx-request.htmx-indicator {
            display: inline-block;
        }
    </style>
</head>
<body class="crt">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>PyNucleus ▚ Developer Console</h1>
            <div class="subtitle">Chemical Process Engineering AI System</div>
            <div class="subtitle">
                <span class="status-indicator status-online"></span>
                System Online | Real-time Diagnostics | Enhanced RAG Pipeline
            </div>
        </header>

        <!-- Mode Selection Tabs -->
        <div class="mode-tabs">
            <button class="mode-tab active" onclick="switchMode('ask')">
                Q&A ENGINE
            </button>
            <button class="mode-tab" onclick="switchMode('search')">
                DOCUMENT SEARCH
            </button>
            <button class="mode-tab" onclick="switchMode('upload')">
                FILE UPLOAD
            </button>
            <button class="mode-tab" onclick="switchMode('diagnostics')">
                SYSTEM DIAGNOSTICS
            </button>
        </div>

        <!-- Q&A Panel -->
        <div id="ask-panel" class="panel active">
            <div class="terminal-box">
                <div class="terminal-header">Question & Answer Engine</div>
                
                <div class="input-group">
                    <label for="question">Enter your chemical engineering question:</label>
                    <textarea 
                        id="question" 
                        name="question" 
                        class="input-field" 
                        rows="4" 
                        placeholder="Example: What are the key parameters for distillation column design?"
                        maxlength="2000"
                    ></textarea>
                </div>
                
                <div>
                    <button 
                        class="btn" 
                        hx-post="/ask" 
                        hx-include="#question" 
                        hx-target="#answer-output" 
                        hx-swap="innerHTML"
                        hx-indicator="#ask-loading"
                    >
                        Process Query
                    </button>
                    <button class="btn btn-warning" onclick="clearAnswer()">
                        Clear Output
                    </button>
                </div>
                
                <div id="ask-loading" class="loading htmx-indicator">
                    ▶ Processing question with RAG pipeline
                </div>
                
                <div id="answer-output" class="output-area">
                    System ready. Enter a question to begin...
                </div>
            </div>
        </div>

        <!-- Document Search Panel -->
        <div id="search-panel" class="panel">
            <div class="terminal-box">
                <div class="terminal-header">Document Retrieval System</div>
                
                <div class="input-group">
                    <label for="search-query">Search documents directly:</label>
                    <input 
                        type="text" 
                        id="search-query" 
                        name="query" 
                        class="input-field" 
                        placeholder="Enter search terms or keywords..."
                        maxlength="500"
                    >
                </div>
                
                <div class="input-group">
                    <label for="search-k">Number of results (1-20):</label>
                    <input 
                        type="number" 
                        id="search-k" 
                        name="k" 
                        class="input-field" 
                        value="5" 
                        min="1" 
                        max="20"
                        style="width: 100px;"
                    >
                </div>
                
                <div>
                    <button 
                        class="btn" 
                        hx-post="/search" 
                        hx-include="#search-query, #search-k" 
                        hx-target="#search-output" 
                        hx-swap="innerHTML"
                        hx-indicator="#search-loading"
                    >
                        Search Documents
                    </button>
                    <button class="btn btn-warning" onclick="clearSearch()">
                        Clear Results
                    </button>
                </div>
                
                <div id="search-loading" class="loading htmx-indicator">
                    ▶ Searching document database
                </div>
                
                <div id="search-output" class="output-area">
                    Ready to search documents. Enter a query to begin...
                </div>
            </div>
        </div>

        <!-- Upload Panel -->
        <div id="upload-panel" class="panel">
            <div class="terminal-box">
                <div class="terminal-header">Document Upload System</div>
                
                <div class="upload-zone" id="upload-zone">
                    <span class="upload-icon">📁</span>
                    <div style="margin-bottom: 15px;">
                        <strong>Drag & Drop files here</strong><br>
                        or click to select files
                    </div>
                    <div style="margin-bottom: 20px;">
                        Supported formats: TXT, PDF, MD, DOC, DOCX, CSV, JSON<br>
                        Maximum file size: 32MB
                    </div>
                    
                    <form hx-post="/upload" 
                          hx-encoding="multipart/form-data" 
                          hx-target="#upload-output" 
                          hx-swap="innerHTML"
                          hx-indicator="#upload-loading"
                          id="upload-form">
                        <input type="file" 
                               id="file-input" 
                               name="file" 
                               class="file-input" 
                               accept=".txt,.pdf,.md,.doc,.docx,.csv,.json"
                               onchange="handleFileSelect(this)">
                        <input type="file" 
                               id="folder-input" 
                               name="folder" 
                               class="file-input" 
                               webkitdirectory
                               directory
                               multiple
                               onchange="handleFolderSelect(this)">
                        <button type="submit" id="hidden-submit-btn" style="display: none;"></button>
                        <label for="file-input" class="file-label">
                            Select File
                        </label>
                        <label for="folder-input" class="file-label" style="margin-left: 10px;">
                            Select Folder
                        </label>
                    </form>
                </div>
                
                <div id="selected-file" class="hidden" style="margin-bottom: 15px;">
                    <strong>Selected:</strong> <span id="file-name"></span>
                    <button class="btn btn-danger" onclick="clearFileSelection()" style="margin-left: 15px;">
                        Clear
                    </button>
                </div>
                
                <div id="upload-loading" class="loading htmx-indicator">
                    ▶ Uploading and processing document
                    <div class="progress-container">
                        <div class="progress-bar" id="upload-progress" style="width: 0%">
                            <div class="progress-text">0%</div>
                        </div>
                        <div class="progress-details">
                            <span id="upload-stage">Initializing...</span>
                            <span id="upload-speed" class="progress-speed"></span>
                        </div>
                        <div class="progress-file-info">
                            <span id="uploaded-bytes">0 KB</span> / <span id="total-bytes">0 KB</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <button class="btn btn-warning" onclick="clearUploadOutput()">
                        Clear Upload Log
                    </button>
                    <button class="btn" onclick="browseFiles()">
                        Browse Files
                    </button>
                </div>
                
                <div id="upload-output" class="output-area">
                    Ready to accept file uploads. Files will be automatically processed and added to the knowledge base.
                </div>
                
                <div id="file-browser" class="terminal-box hidden" style="margin-top: 20px;">
                    <div class="terminal-header">File Browser</div>
                    <div id="file-browser-content">
                        Click "Browse Files" to see uploaded documents...
                    </div>
                </div>
            </div>
        </div>

        <!-- Diagnostics Panel -->
        <div id="diagnostics-panel" class="panel">
            <div class="terminal-box">
                <div class="terminal-header">Real-time System Diagnostics</div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="refreshDiagnostics()">
                        Refresh All
                    </button>
                    <button class="btn" 
                            hx-get="/status" 
                            hx-target="#status-output" 
                            hx-swap="innerHTML"
                            hx-indicator="#status-loading">
                        System Status
                    </button>
                    <button class="btn" 
                            hx-get="/system_statistics" 
                            hx-target="#stats-output" 
                            hx-swap="innerHTML"
                            hx-indicator="#stats-loading">
                        Full Statistics
                    </button>
                    <button class="btn btn-warning" 
                            hx-get="/system_diagnostic" 
                            hx-target="#diagnostic-output" 
                            hx-swap="innerHTML"
                            hx-indicator="#diagnostic-loading">
                        Run Diagnostics
                    </button>
                </div>
                
                <!-- Real-time metrics cards -->
                <div class="diagnostics-grid">
                    <div class="diagnostic-card">
                        <div class="diagnostic-title">
                            🖥️ System Status
                        </div>
                        <div class="diagnostic-value" id="system-status">
                            <span class="status-indicator status-online"></span>
                            Operational
                        </div>
                        <div class="diagnostic-desc">Core system health</div>
                    </div>
                    
                    <div class="diagnostic-card">
                        <div class="diagnostic-title">
                            🗄️ Vector Database
                        </div>
                        <div class="diagnostic-value" id="db-status">
                            <span class="status-indicator status-online"></span>
                            Ready (0 docs)
                        </div>
                        <div class="diagnostic-desc">Document storage status</div>
                    </div>
                    
                    <div class="diagnostic-card">
                        <div class="diagnostic-title">
                            🧠 AI Model
                        </div>
                        <div class="diagnostic-value" id="model-status">
                            <span class="status-indicator status-online"></span>
                            Loaded
                        </div>
                        <div class="diagnostic-desc">Language model status</div>
                    </div>
                    
                    <div class="diagnostic-card">
                        <div class="diagnostic-title">
                            📊 Memory Usage
                        </div>
                        <div class="diagnostic-value" id="memory-status">
                            <span class="status-indicator status-online"></span>
                            0.0% Used
                        </div>
                        <div class="diagnostic-desc">System memory consumption</div>
                    </div>
                </div>
                
                <div id="status-loading" class="loading htmx-indicator">
                    ▶ Loading system status
                </div>
                
                <div id="stats-loading" class="loading htmx-indicator">
                    ▶ Loading system statistics
                </div>
                
                <div id="diagnostic-loading" class="loading htmx-indicator">
                    ▶ Running comprehensive diagnostics
                </div>
                
                <div id="status-output" class="output-area">
                    Click "System Status" to load real-time system information...
                </div>
                
                <div id="stats-output" class="output-area hidden">
                    Click "Full Statistics" to load comprehensive system statistics...
                </div>
                
                <div id="diagnostic-output" class="output-area hidden">
                    Click "Run Diagnostics" to perform system validation...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mode switching functionality
        function switchMode(mode, clickedElement) {
            console.log('switchMode called with mode:', mode);
            
            // Update tabs
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find the clicked tab by mode and make it active
            const targetTab = Array.from(document.querySelectorAll('.mode-tab')).find(tab => 
                tab.getAttribute('onclick').includes(`'${mode}'`)
            );
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Update panels
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            const targetPanel = document.getElementById(mode + '-panel');
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log('Switched to panel:', mode + '-panel');
            } else {
                console.error('Panel not found:', mode + '-panel');
            }
            
            // Auto-load diagnostics when switching to that mode
            if (mode === 'diagnostics') {
                setTimeout(autoRefreshDiagnostics, 500);
            }
        }
        
        // File upload drag and drop
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const folderInput = document.getElementById('folder-input');
        
        // Global file input trigger functions
        window.triggerFileSelect = function() {
            console.log('Triggering file select');
            if (fileInput) {
                fileInput.click();
            } else {
                console.error('File input not found');
            }
        };
        
        window.triggerFolderSelect = function() {
            console.log('Triggering folder select');
            if (folderInput) {
                folderInput.click();
            } else {
                console.error('Folder input not found');
            }
        };
        
        // File input event listeners
        fileInput.addEventListener('click', () => {
            console.log('File input clicked');
        });
        
        folderInput.addEventListener('click', () => {
            console.log('Folder input clicked');
        });
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        
        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Set the file input to the dropped file
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                fileInput.files = dataTransfer.files;
                handleFileSelect(fileInput);
            }
        });
        
        uploadZone.addEventListener('click', (e) => {
            // Don't trigger if user clicked on any interactive element
            if (e.target.classList.contains('file-label') || 
                e.target.closest('.file-label') ||
                e.target.tagName === 'LABEL' ||
                e.target.tagName === 'INPUT' ||
                e.target.tagName === 'BUTTON') {
                console.log('Skipping upload zone trigger for:', e.target.tagName, e.target.className);
                return; // Let the element handle the click naturally
            }
            
            // Only trigger for clicks on the upload zone background/text
            if (e.target === uploadZone || 
                (e.target.closest('.upload-zone') && !e.target.closest('form'))) {
                console.log('Upload zone clicked, triggering file select');
                e.preventDefault();
                window.triggerFileSelect();
            }
        });
        
        // File selection functions are defined later with enhanced progress tracking
        
        // Clear functions
        function clearAnswer() {
            document.getElementById('answer-output').textContent = 'System ready. Enter a question to begin...';
            document.getElementById('question').value = '';
        }
        
        function clearSearch() {
            document.getElementById('search-output').textContent = 'Ready to search documents. Enter a query to begin...';
            document.getElementById('search-query').value = '';
        }
        
        function clearUploadOutput() {
            document.getElementById('upload-output').textContent = 'Ready to accept file uploads. Files will be automatically processed and added to the knowledge base.';
        }
        
        function browseFiles() {
            const fileBrowser = document.getElementById('file-browser');
            const content = document.getElementById('file-browser-content');
            
            // Show the browser
            fileBrowser.classList.remove('hidden');
            content.innerHTML = 'Loading files...';
            
            fetch('/browse_files')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        content.innerHTML = `Error: ${data.error}`;
                        return;
                    }
                    
                    let formatted = `┌─ FILE BROWSER ───────────────────────────────────┐\n`;
                    formatted += `│ Source Documents: ${data.summary.source_count} files\n`;
                    formatted += `│ Processed Text: ${data.summary.cleaned_count} files\n`;
                    formatted += `│ Total Size: ${formatBytes(data.summary.total_source_size)}\n`;
                    formatted += `└──────────────────────────────────────────────────┘\n\n`;
                    
                    if (data.directories.source_documents.length > 0) {
                        formatted += `📁 SOURCE DOCUMENTS:\n`;
                        data.directories.source_documents.forEach(file => {
                            formatted += `  • ${file.name} (${formatBytes(file.size)}) - ${file.modified_str}\n`;
                        });
                        formatted += `\n`;
                    }
                    
                    if (data.directories.cleaned_txt.length > 0) {
                        formatted += `📄 PROCESSED TEXT FILES:\n`;
                        data.directories.cleaned_txt.forEach(file => {
                            formatted += `  • ${file.name} (${formatBytes(file.size)}) - ${file.modified_str}\n`;
                        });
                        formatted += `\n`;
                    }
                    
                    if (data.directories.source_documents.length === 0 && data.directories.cleaned_txt.length === 0) {
                        formatted += `No files found. Upload some documents to get started!\n`;
                    }
                    
                    content.textContent = formatted;
                })
                .catch(error => {
                    console.error('File browser error:', error);
                    content.innerHTML = `Error loading files: ${error.message}`;
                });
        }
        
        // Diagnostics functions
        function refreshDiagnostics() {
            htmx.trigger(document.querySelector('[hx-get="/status"]'), 'click');
            autoRefreshDiagnostics();
        }
        
        function autoRefreshDiagnostics() {
            // Auto-refresh diagnostics every 30 seconds when on diagnostics panel
            if (document.getElementById('diagnostics-panel').classList.contains('active')) {
                fetch('/status')
                    .then(response => response.json())
                    .then(data => updateDiagnosticCards(data))
                    .catch(error => console.error('Error updating diagnostics:', error));
            }
        }
        
        function updateDiagnosticCards(data) {
            // Update system status
            const systemStatus = document.getElementById('system-status');
            const statusIndicator = systemStatus.querySelector('.status-indicator');
            if (data.status === 'operational') {
                statusIndicator.className = 'status-indicator status-online';
                systemStatus.innerHTML = '<span class="status-indicator status-online"></span>Operational';
            } else {
                statusIndicator.className = 'status-indicator status-warning';
                systemStatus.innerHTML = '<span class="status-indicator status-warning"></span>Degraded';
            }
            
            // Update database status
            const dbStatus = document.getElementById('db-status');
            const dbIndicator = dbStatus.querySelector('.status-indicator');
            if (data.database && data.database.status === 'ready') {
                dbIndicator.className = 'status-indicator status-online';
                dbStatus.innerHTML = `<span class="status-indicator status-online"></span>Ready (${data.database.estimated_docs || 0} docs)`;
            } else {
                dbIndicator.className = 'status-indicator status-warning';
                dbStatus.innerHTML = '<span class="status-indicator status-warning"></span>Not Ready';
            }
            
            // Update model status
            const modelStatus = document.getElementById('model-status');
            const modelIndicator = modelStatus.querySelector('.status-indicator');
            if (data.model && data.model.model_id !== 'unknown') {
                modelIndicator.className = 'status-indicator status-online';
                modelStatus.innerHTML = '<span class="status-indicator status-online"></span>Loaded';
            } else {
                modelIndicator.className = 'status-indicator status-warning';
                modelStatus.innerHTML = '<span class="status-indicator status-warning"></span>Loading...';
            }
            
            // Update memory status
            const memoryStatus = document.getElementById('memory-status');
            const memoryIndicator = memoryStatus.querySelector('.status-indicator');
            if (data.system && data.system.memory_percent) {
                const memPercent = data.system.memory_percent;
                if (memPercent < 80) {
                    memoryIndicator.className = 'status-indicator status-online';
                } else if (memPercent < 90) {
                    memoryIndicator.className = 'status-indicator status-warning';
                } else {
                    memoryIndicator.className = 'status-indicator status-error';
                }
                memoryStatus.innerHTML = `<span class="${memoryIndicator.className}"></span>${memPercent}% Used`;
            }
        }
        
        // Enhanced upload progress tracking
        let uploadStartTime = 0;
        let uploadFileSize = 0;
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatSpeed(bytesPerSecond) {
            return formatBytes(bytesPerSecond) + '/s';
        }
        
        function updateProgressStage(stage) {
            const stageElement = document.getElementById('upload-stage');
            if (stageElement) {
                stageElement.textContent = stage;
            }
        }
        
        function handleFileSelect(input) {
            console.log('handleFileSelect called', input, input.files);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                console.log('File selected:', file.name, file.size);
                uploadFileSize = file.size;
                
                // Validate file size (32MB limit)
                const maxSize = 32 * 1024 * 1024;
                if (file.size > maxSize) {
                    alert(`File size (${formatBytes(file.size)}) exceeds the 32MB limit.`);
                    input.value = '';
                    return;
                }
                
                // Show selected file
                document.getElementById('file-name').textContent = file.name + ` (${formatBytes(file.size)})`;
                document.getElementById('selected-file').classList.remove('hidden');
                
                // Update total bytes display
                document.getElementById('total-bytes').textContent = formatBytes(file.size);
                
                // Auto-submit using HTMX by clicking hidden submit button
                setTimeout(() => {
                    console.log('Auto-submitting upload form via HTMX');
                    const submitBtn = document.getElementById('hidden-submit-btn');
                    if (submitBtn) {
                        submitBtn.click();
                    } else {
                        console.error('Hidden submit button not found');
                    }
                }, 100);
            }
        }
        
        function handleFolderSelect(input) {
            console.log('handleFolderSelect called', input, input.files);
            if (input.files && input.files.length > 0) {
                const files = Array.from(input.files);
                const supportedFiles = files.filter(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ['txt', 'pdf', 'md', 'doc', 'docx', 'csv', 'json'].includes(ext);
                });
                
                if (supportedFiles.length === 0) {
                    alert('No supported files found in the selected folder.');
                    return;
                }
                
                console.log(`Found ${supportedFiles.length} supported files in folder`);
                
                // Calculate total size
                uploadFileSize = supportedFiles.reduce((total, file) => total + file.size, 0);
                
                // Validate total size (32MB limit)
                const maxSize = 32 * 1024 * 1024;
                if (uploadFileSize > maxSize) {
                    alert(`Total folder size (${formatBytes(uploadFileSize)}) exceeds the 32MB limit.`);
                    input.value = '';
                    return;
                }
                
                // Show selected folder info
                document.getElementById('file-name').textContent = `${supportedFiles.length} files from folder (${formatBytes(uploadFileSize)})`;
                document.getElementById('selected-file').classList.remove('hidden');
                
                // Update total bytes display
                document.getElementById('total-bytes').textContent = formatBytes(uploadFileSize);
                
                // Process files one by one (simplified for demo)
                alert(`Ready to upload ${supportedFiles.length} files. Feature coming soon!`);
            }
        }
        
        function clearFileSelection() {
            document.getElementById('file-input').value = '';
            document.getElementById('folder-input').value = '';
            document.getElementById('selected-file').classList.add('hidden');
            uploadFileSize = 0;
        }
        
        // Real upload progress tracking
        document.addEventListener('htmx:beforeRequest', function(event) {
            if (event.detail.target.id === 'upload-output') {
                uploadStartTime = Date.now();
                const progressBar = document.getElementById('upload-progress');
                const progressText = progressBar.querySelector('.progress-text');
                const uploadSpeed = document.getElementById('upload-speed');
                const uploadedBytes = document.getElementById('uploaded-bytes');
                
                updateProgressStage('Preparing upload...');
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                uploadedBytes.textContent = '0 KB';
                uploadSpeed.textContent = '';
                
                // Simulate real upload progress tracking
                let uploadedSize = 0;
                const interval = setInterval(() => {
                    const elapsed = (Date.now() - uploadStartTime) / 1000;
                    
                    if (uploadFileSize > 0) {
                        // Realistic upload simulation based on file size
                        const progressRate = Math.min(1, elapsed / Math.max(2, uploadFileSize / (1024 * 1024))); // At least 2 seconds
                        uploadedSize = Math.min(uploadFileSize * progressRate, uploadFileSize * 0.95);
                        
                        const progress = (uploadedSize / uploadFileSize) * 100;
                        const speed = uploadedSize / elapsed;
                        
                        progressBar.style.width = progress + '%';
                        progressText.textContent = Math.round(progress) + '%';
                        uploadedBytes.textContent = formatBytes(uploadedSize);
                        
                        if (elapsed > 0.5) {
                            uploadSpeed.textContent = formatSpeed(speed);
                        }
                        
                        if (progress < 30) {
                            updateProgressStage('Uploading file...');
                        } else if (progress < 70) {
                            updateProgressStage('Processing document...');
                        } else if (progress < 95) {
                            updateProgressStage('Adding to knowledge base...');
                        }
                    }
                }, 200);
                
                // Clear progress when request completes
                document.addEventListener('htmx:afterRequest', function clearProgress(event) {
                    clearInterval(interval);
                    
                    // Check if the upload was successful or failed
                    const isSuccess = event.detail.xhr.status === 200;
                    
                    if (isSuccess) {
                        updateProgressStage('Finalizing...');
                        progressBar.style.width = '100%';
                        progressText.textContent = '100%';
                        uploadedBytes.textContent = formatBytes(uploadFileSize);
                    } else {
                        // Handle error state
                        updateProgressStage('Upload Failed');
                        progressBar.style.width = '0%';
                        progressBar.style.background = 'linear-gradient(90deg, #ff4444, #cc0000)';
                        progressText.textContent = 'Error';
                    }
                    
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';
                        progressBar.style.background = 'linear-gradient(90deg, #00ff41, #00cc33)'; // Reset color
                        uploadedBytes.textContent = '0 KB';
                        uploadSpeed.textContent = '';
                        updateProgressStage('Ready');
                        clearFileSelection();
                    }, isSuccess ? 2000 : 3000); // Show error state longer
                    
                    document.removeEventListener('htmx:afterRequest', clearProgress);
                }, { once: true });
                
                // Handle upload errors separately
                document.addEventListener('htmx:responseError', function clearProgressError() {
                    clearInterval(interval);
                    updateProgressStage('Upload Failed');
                    progressBar.style.width = '0%';
                    progressBar.style.background = 'linear-gradient(90deg, #ff4444, #cc0000)';
                    progressText.textContent = 'Error';
                    uploadSpeed.textContent = 'Failed';
                    
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';
                        progressBar.style.background = 'linear-gradient(90deg, #00ff41, #00cc33)';
                        uploadedBytes.textContent = '0 KB';
                        uploadSpeed.textContent = '';
                        updateProgressStage('Ready');
                        clearFileSelection();
                    }, 3000);
                    
                    document.removeEventListener('htmx:responseError', clearProgressError);
                }, { once: true });
            }
        });
        
        // Enhanced response formatting
        document.addEventListener('htmx:afterRequest', function(event) {
            const target = event.detail.target;
            
            // Format ask responses
            if (target.id === 'answer-output') {
                try {
                    const responseText = target.textContent;
                    const jsonData = JSON.parse(responseText);
                    
                    if (jsonData.answer) {
                        let formatted = `┌─ QUERY RESPONSE ────────────────────────────────┐\n`;
                        formatted += `│ Q: ${document.getElementById('question').value.substring(0, 60)}...\n`;
                        formatted += `└─────────────────────────────────────────────────┘\n\n`;
                        formatted += `${jsonData.answer}\n\n`;
                        
                        if (jsonData.sources && jsonData.sources.length > 0) {
                            formatted += `┌─ DOCUMENT SOURCES ──────────────────────────────┐\n`;
                            jsonData.sources.forEach((source, i) => {
                                formatted += `│ [${i+1}] ${source}\n`;
                            });
                            formatted += `└─────────────────────────────────────────────────┘\n\n`;
                        }
                        
                        if (jsonData.metadata) {
                            formatted += `┌─ PROCESSING METADATA ───────────────────────────┐\n`;
                            formatted += `│ Response Time: ${jsonData.metadata.processing_time}s\n`;
                            formatted += `│ Model: ${jsonData.metadata.model}\n`;
                            formatted += `│ Retrieved Docs: ${jsonData.retrieved_documents || 0}\n`;
                            if (jsonData.metadata.reasoning_steps) {
                                formatted += `│ Reasoning Steps:\n`;
                                jsonData.metadata.reasoning_steps.forEach(step => {
                                    formatted += `│   • ${step}\n`;
                                });
                            }
                            formatted += `└─────────────────────────────────────────────────┘`;
                        }
                        
                        target.textContent = formatted;
                    } else if (jsonData.error) {
                        target.textContent = `ERROR: ${jsonData.error}`;
                    }
                } catch (e) {
                    // If not JSON, leave as is
                }
            }
            
            // Format search responses
            if (target.id === 'search-output') {
                try {
                    const responseText = target.textContent;
                    const jsonData = JSON.parse(responseText);
                    
                    if (jsonData.results) {
                        let formatted = `┌─ SEARCH RESULTS ─────────────────────────────────┐\n`;
                        formatted += `│ Query: "${jsonData.query}"\n`;
                        formatted += `│ Found: ${jsonData.total_found} documents\n`;
                        formatted += `│ Processing Time: ${jsonData.processing_time}s\n`;
                        formatted += `└──────────────────────────────────────────────────┘\n\n`;
                        
                        if (jsonData.results.length > 0) {
                            jsonData.results.forEach((result, i) => {
                                formatted += `▶ DOCUMENT ${i + 1} (Relevance: ${(result.relevance_score * 100).toFixed(1)}%)\n`;
                                formatted += `${result.content}\n`;
                                if (result.metadata) {
                                    formatted += `[Length: ${result.metadata.length} chars, Tokens: ~${result.metadata.estimated_tokens}]\n`;
                                }
                                formatted += `${'─'.repeat(50)}\n`;
                            });
                        } else {
                            formatted += `No documents found matching your query.\n`;
                        }
                        
                        target.textContent = formatted;
                    } else if (jsonData.error) {
                        target.textContent = `SEARCH ERROR: ${jsonData.error}`;
                    }
                } catch (e) {
                    // If not JSON, leave as is
                }
            }
            
            // Format upload responses
            if (target.id === 'upload-output') {
                try {
                    const responseText = target.textContent;
                    const jsonData = JSON.parse(responseText);
                    
                    if (jsonData.processing_info) {
                        const info = jsonData.processing_info;
                        let formatted = `┌─ UPLOAD RESULTS ─────────────────────────────────┐\n`;
                        formatted += `│ File: ${info.original_filename}\n`;
                        formatted += `│ Size: ${info.file_size_mb} MB\n`;
                        formatted += `│ Status: ${info.processing_status.toUpperCase()}\n`;
                        formatted += `│ Processing Time: ${info.processing_time}s\n`;
                        formatted += `└──────────────────────────────────────────────────┘\n\n`;
                        
                        formatted += `MESSAGE: ${jsonData.message}\n\n`;
                        
                        if (info.vector_db_status) {
                            formatted += `Vector DB Integration: ${info.vector_db_status.toUpperCase()}\n`;
                        }
                        
                        if (info.content_preview) {
                            formatted += `\nCONTENT PREVIEW:\n${info.content_preview.substring(0, 200)}...\n`;
                        }
                        
                        if (jsonData.next_steps) {
                            formatted += `\nNEXT STEPS:\n`;
                            jsonData.next_steps.forEach(step => {
                                formatted += `• ${step}\n`;
                            });
                        }
                        
                        if (jsonData.quick_test) {
                            formatted += `\nQUICK TEST:\n`;
                            formatted += `• Query: "${jsonData.quick_test.suggested_query}"\n`;
                            formatted += `• File Available: ${jsonData.quick_test.file_available_for_qa ? 'YES' : 'NO'}\n`;
                            formatted += `• Estimated Chunks: ${jsonData.quick_test.estimated_chunks}\n`;
                        }
                        
                        target.textContent = formatted;
                    } else if (jsonData.error) {
                        let errorFormatted = `┌─ UPLOAD ERROR ───────────────────────────────────┐
│ ERROR: ${jsonData.error}
└──────────────────────────────────────────────────┘`;
                        target.textContent = errorFormatted;
                    }
                } catch (e) {
                    // If not JSON, leave as is
                }
            }
        });
        
        // Initialize the first tab on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set the first tab as active by default
            switchMode('ask');
        });
    </script>
</body>
</html>