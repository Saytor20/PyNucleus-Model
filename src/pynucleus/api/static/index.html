<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyNucleus ‚ñö Developer Console</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        /* Old-computer terminal aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            color: #00ff41;
            font-family: 'Courier Prime', 'Courier New', monospace;
            line-height: 1.4;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* CRT screen effects */
        .crt::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%, 
                rgba(0, 0, 0, 0.25) 50%
            );
            background-size: 100% 2px;
            z-index: 1000;
            opacity: 0.1;
        }
        
        .crt::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(
                ellipse at center,
                rgba(0, 255, 65, 0.02) 0%,
                rgba(0, 0, 0, 0.1) 100%
            );
            z-index: 999;
        }
        
        /* Main container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid #00ff41;
            padding: 20px;
            background: rgba(0, 255, 65, 0.05);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ff41;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px #00ff41; }
            to { text-shadow: 0 0 20px #00ff41, 0 0 30px #00ff41; }
        }
        
        /* Mode tabs */
        .mode-tabs {
            display: flex;
            margin-bottom: 20px;
            border: 1px solid #00ff41;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .mode-tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: #00ff41;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            border-right: 1px solid #00ff41;
            transition: all 0.3s ease;
        }
        
        .mode-tab:last-child {
            border-right: none;
        }
        
        .mode-tab:hover {
            background: rgba(0, 255, 65, 0.1);
        }
        
        .mode-tab.active {
            background: #00ff41;
            color: #000;
            font-weight: bold;
        }
        
        /* Content panels */
        .panel {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Terminal-style boxes */
        .terminal-box {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff41;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier Prime', monospace;
        }
        
        .terminal-header {
            font-size: 1.2rem;
            color: #00ff41;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #00ff41;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .terminal-header::before {
            content: "‚ñ∂";
            color: #ffaa00;
        }
        
        /* Form elements */
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            color: #00ff41;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-field {
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #ffaa00;
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.3);
        }
        
        .btn {
            background: transparent;
            border: 2px solid #00ff41;
            color: #00ff41;
            padding: 12px 24px;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #00ff41;
            color: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 255, 65, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            border-color: #ff4444;
            color: #ff4444;
        }
        
        .btn-danger:hover {
            background: #ff4444;
            color: #000;
        }
        
        .btn-warning {
            border-color: #ffaa00;
            color: #ffaa00;
        }
        
        .btn-warning:hover {
            background: #ffaa00;
            color: #000;
        }
        
        /* Output areas */
        .output-area {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00ff41;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier Prime', monospace;
            margin-top: 15px;
        }
        
        .output-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .output-area::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .output-area::-webkit-scrollbar-thumb {
            background: #00ff41;
            border-radius: 4px;
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-online {
            background: #00ff41;
        }
        
        .status-warning {
            background: #ffaa00;
        }
        
        .status-error {
            background: #ff4444;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Drag and drop upload */
        .upload-zone {
            border: 2px dashed #00ff41;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: rgba(0, 255, 65, 0.02);
        }
        
        .upload-zone.drag-over {
            border-color: #ffaa00;
            background: rgba(255, 170, 0, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 15px 30px;
            border: 2px solid #00ff41;
            color: #00ff41;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .file-label:hover {
            background: #00ff41;
            color: #000;
        }
        
        /* Progress bar */
        .progress-container {
            margin: 15px 0;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff41;
            height: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff41, #00cc33);
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-weight: bold;
            z-index: 1;
        }
        
        /* Real-time diagnostics */
        .diagnostics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .diagnostic-card {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            padding: 20px;
        }
        
        .diagnostic-title {
            color: #ffaa00;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .diagnostic-value {
            font-size: 1.5rem;
            color: #00ff41;
            margin-bottom: 5px;
        }
        
        .diagnostic-desc {
            color: #888;
            font-size: 0.9rem;
        }
        
        /* Loading states */
        .loading {
            display: none;
            color: #ffaa00;
            margin: 10px 0;
        }
        
        .loading.active {
            display: block;
        }
        
        .loading::after {
            content: "...";
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60% { content: "..."; }
            80%, 100% { content: ""; }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .mode-tabs {
                flex-direction: column;
            }
            
            .mode-tab {
                border-right: none;
                border-bottom: 1px solid #00ff41;
            }
            
            .mode-tab:last-child {
                border-bottom: none;
            }
            
            .diagnostics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Hidden utility class */
        .hidden {
            display: none !important;
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* HTMX indicators */
        .htmx-indicator {
            display: none;
        }
        
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        
        .htmx-request.htmx-indicator {
            display: inline-block;
        }
    </style>
</head>
<body class="crt">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>PyNucleus ‚ñö Developer Console</h1>
            <div class="subtitle">Chemical Process Engineering AI System</div>
            <div class="subtitle">
                <span class="status-indicator status-online"></span>
                System Online | Real-time Diagnostics | Enhanced RAG Pipeline
            </div>
        </header>

        <!-- Mode Selection Tabs -->
        <div class="mode-tabs">
            <button class="mode-tab active" onclick="switchMode('ask')">
                Q&A ENGINE
            </button>
            <button class="mode-tab" onclick="switchMode('search')">
                DOCUMENT SEARCH
            </button>
            <button class="mode-tab" onclick="switchMode('upload')">
                FILE UPLOAD
            </button>
            <button class="mode-tab" onclick="switchMode('diagnostics')">
                SYSTEM DIAGNOSTICS
            </button>
        </div>

        <!-- Q&A Panel -->
        <div id="ask-panel" class="panel active">
            <div class="terminal-box">
                <div class="terminal-header">Question & Answer Engine</div>
                
                <div class="input-group">
                    <label for="question">Enter your chemical engineering question:</label>
                    <textarea 
                        id="question" 
                        name="question" 
                        class="input-field" 
                        rows="4" 
                        placeholder="Example: What are the key parameters for distillation column design?"
                        maxlength="2000"
                    ></textarea>
                </div>
                
                <div>
                    <button 
                        class="btn" 
                        hx-post="/ask" 
                        hx-include="#question" 
                        hx-target="#answer-output" 
                        hx-swap="innerHTML"
                        hx-indicator="#ask-loading"
                    >
                        Process Query
                    </button>
                    <button class="btn btn-warning" onclick="clearAnswer()">
                        Clear Output
                    </button>
                </div>
                
                <div id="ask-loading" class="loading htmx-indicator">
                    ‚ñ∂ Processing question with RAG pipeline
                </div>
                
                <div id="answer-output" class="output-area">
                    System ready. Enter a question to begin...
                </div>
            </div>
        </div>

        <!-- Document Search Panel -->
        <div id="search-panel" class="panel">
            <div class="terminal-box">
                <div class="terminal-header">Document Retrieval System</div>
                
                <div class="input-group">
                    <label for="search-query">Search documents directly:</label>
                    <input 
                        type="text" 
                        id="search-query" 
                        name="query" 
                        class="input-field" 
                        placeholder="Enter search terms or keywords..."
                        maxlength="500"
                    >
                </div>
                
                <div class="input-group">
                    <label for="search-k">Number of results (1-20):</label>
                    <input 
                        type="number" 
                        id="search-k" 
                        name="k" 
                        class="input-field" 
                        value="5" 
                        min="1" 
                        max="20"
                        style="width: 100px;"
                    >
                </div>
                
                <div>
                    <button 
                        class="btn" 
                        hx-post="/search" 
                        hx-include="#search-query, #search-k" 
                        hx-target="#search-output" 
                        hx-swap="innerHTML"
                        hx-indicator="#search-loading"
                    >
                        Search Documents
                    </button>
                    <button class="btn btn-warning" onclick="clearSearch()">
                        Clear Results
                    </button>
                </div>
                
                <div id="search-loading" class="loading htmx-indicator">
                    ‚ñ∂ Searching document database
                </div>
                
                <div id="search-output" class="output-area">
                    Ready to search documents. Enter a query to begin...
                </div>
            </div>
        </div>

        <!-- Upload Panel -->
        <div id="upload-panel" class="panel">
            <div class="terminal-box">
                <div class="terminal-header">Document Upload System</div>
                
                <div class="upload-zone" id="upload-zone">
                    <span class="upload-icon">üìÅ</span>
                    <div style="margin-bottom: 15px;">
                        <strong>Drag & Drop files here</strong><br>
                        or click to select files
                    </div>
                    <div style="margin-bottom: 20px;">
                        Supported formats: TXT, PDF, MD, DOC, DOCX, CSV, JSON<br>
                        Maximum file size: 32MB
                    </div>
                    
                    <form hx-post="/upload" 
                          hx-encoding="multipart/form-data" 
                          hx-target="#upload-output" 
                          hx-swap="innerHTML"
                          hx-indicator="#upload-loading"
                          id="upload-form">
                        <input type="file" 
                               id="file-input" 
                               name="file" 
                               class="file-input" 
                               accept=".txt,.pdf,.md,.doc,.docx,.csv,.json"
                               onchange="handleFileSelect(this)">
                        <label for="file-input" class="file-label">
                            Select File
                        </label>
                    </form>
                </div>
                
                <div id="selected-file" class="hidden" style="margin-bottom: 15px;">
                    <strong>Selected:</strong> <span id="file-name"></span>
                    <button class="btn btn-danger" onclick="clearFileSelection()" style="margin-left: 15px;">
                        Clear
                    </button>
                </div>
                
                <div id="upload-loading" class="loading htmx-indicator">
                    ‚ñ∂ Uploading and processing document
                    <div class="progress-container">
                        <div class="progress-bar" id="upload-progress" style="width: 0%">
                            <div class="progress-text">0%</div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <button class="btn btn-warning" onclick="clearUploadOutput()">
                        Clear Upload Log
                    </button>
                </div>
                
                <div id="upload-output" class="output-area">
                    Ready to accept file uploads. Files will be automatically processed and added to the knowledge base.
                </div>
            </div>
        </div>

        <!-- Diagnostics Panel -->
        <div id="diagnostics-panel" class="panel">
            <div class="terminal-box">
                <div class="terminal-header">Real-time System Diagnostics</div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="refreshDiagnostics()">
                        Refresh All
                    </button>
                    <button class="btn" 
                            hx-get="/status" 
                            hx-target="#status-output" 
                            hx-swap="innerHTML"
                            hx-indicator="#status-loading">
                        System Status
                    </button>
                    <button class="btn" 
                            hx-get="/system_statistics" 
                            hx-target="#stats-output" 
                            hx-swap="innerHTML"
                            hx-indicator="#stats-loading">
                        Full Statistics
                    </button>
                    <button class="btn btn-warning" 
                            hx-get="/system_diagnostic" 
                            hx-target="#diagnostic-output" 
                            hx-swap="innerHTML"
                            hx-indicator="#diagnostic-loading">
                        Run Diagnostics
                    </button>
                </div>
                
                <!-- Real-time metrics cards -->
                <div class="diagnostics-grid">
                    <div class="diagnostic-card">
                        <div class="diagnostic-title">
                            üñ•Ô∏è System Status
                        </div>
                        <div class="diagnostic-value" id="system-status">
                            <span class="status-indicator status-online"></span>
                            Operational
                        </div>
                        <div class="diagnostic-desc">Core system health</div>
                    </div>
                    
                    <div class="diagnostic-card">
                        <div class="diagnostic-title">
                            üóÑÔ∏è Vector Database
                        </div>
                        <div class="diagnostic-value" id="db-status">
                            <span class="status-indicator status-online"></span>
                            Ready (0 docs)
                        </div>
                        <div class="diagnostic-desc">Document storage status</div>
                    </div>
                    
                    <div class="diagnostic-card">
                        <div class="diagnostic-title">
                            üß† AI Model
                        </div>
                        <div class="diagnostic-value" id="model-status">
                            <span class="status-indicator status-online"></span>
                            Loaded
                        </div>
                        <div class="diagnostic-desc">Language model status</div>
                    </div>
                    
                    <div class="diagnostic-card">
                        <div class="diagnostic-title">
                            üìä Memory Usage
                        </div>
                        <div class="diagnostic-value" id="memory-status">
                            <span class="status-indicator status-online"></span>
                            0.0% Used
                        </div>
                        <div class="diagnostic-desc">System memory consumption</div>
                    </div>
                </div>
                
                <div id="status-loading" class="loading htmx-indicator">
                    ‚ñ∂ Loading system status
                </div>
                
                <div id="stats-loading" class="loading htmx-indicator">
                    ‚ñ∂ Loading system statistics
                </div>
                
                <div id="diagnostic-loading" class="loading htmx-indicator">
                    ‚ñ∂ Running comprehensive diagnostics
                </div>
                
                <div id="status-output" class="output-area">
                    Click "System Status" to load real-time system information...
                </div>
                
                <div id="stats-output" class="output-area hidden">
                    Click "Full Statistics" to load comprehensive system statistics...
                </div>
                
                <div id="diagnostic-output" class="output-area hidden">
                    Click "Run Diagnostics" to perform system validation...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mode switching functionality
        function switchMode(mode) {
            // Update tabs
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update panels
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(mode + '-panel').classList.add('active');
            
            // Auto-load diagnostics when switching to that mode
            if (mode === 'diagnostics') {
                setTimeout(autoRefreshDiagnostics, 500);
            }
        }
        
        // File upload drag and drop
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        
        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(fileInput);
            }
        });
        
        uploadZone.addEventListener('click', (e) => {
            if (e.target === uploadZone || e.target.closest('.upload-zone')) {
                fileInput.click();
            }
        });
        
        function handleFileSelect(input) {
            const selectedFile = document.getElementById('selected-file');
            const fileName = document.getElementById('file-name');
            
            if (input.files.length > 0) {
                fileName.textContent = input.files[0].name;
                selectedFile.classList.remove('hidden');
                
                // Auto-submit the form
                htmx.trigger('#upload-form', 'submit');
            }
        }
        
        function clearFileSelection() {
            const fileInput = document.getElementById('file-input');
            const selectedFile = document.getElementById('selected-file');
            fileInput.value = '';
            selectedFile.classList.add('hidden');
        }
        
        // Clear functions
        function clearAnswer() {
            document.getElementById('answer-output').textContent = 'System ready. Enter a question to begin...';
            document.getElementById('question').value = '';
        }
        
        function clearSearch() {
            document.getElementById('search-output').textContent = 'Ready to search documents. Enter a query to begin...';
            document.getElementById('search-query').value = '';
        }
        
        function clearUploadOutput() {
            document.getElementById('upload-output').textContent = 'Ready to accept file uploads. Files will be automatically processed and added to the knowledge base.';
        }
        
        // Diagnostics functions
        function refreshDiagnostics() {
            htmx.trigger(document.querySelector('[hx-get="/status"]'), 'click');
            autoRefreshDiagnostics();
        }
        
        function autoRefreshDiagnostics() {
            // Auto-refresh diagnostics every 30 seconds when on diagnostics panel
            if (document.getElementById('diagnostics-panel').classList.contains('active')) {
                fetch('/status')
                    .then(response => response.json())
                    .then(data => updateDiagnosticCards(data))
                    .catch(error => console.error('Error updating diagnostics:', error));
            }
        }
        
        function updateDiagnosticCards(data) {
            // Update system status
            const systemStatus = document.getElementById('system-status');
            const statusIndicator = systemStatus.querySelector('.status-indicator');
            if (data.status === 'operational') {
                statusIndicator.className = 'status-indicator status-online';
                systemStatus.innerHTML = '<span class="status-indicator status-online"></span>Operational';
            } else {
                statusIndicator.className = 'status-indicator status-warning';
                systemStatus.innerHTML = '<span class="status-indicator status-warning"></span>Degraded';
            }
            
            // Update database status
            const dbStatus = document.getElementById('db-status');
            const dbIndicator = dbStatus.querySelector('.status-indicator');
            if (data.database && data.database.status === 'ready') {
                dbIndicator.className = 'status-indicator status-online';
                dbStatus.innerHTML = `<span class="status-indicator status-online"></span>Ready (${data.database.estimated_docs || 0} docs)`;
            } else {
                dbIndicator.className = 'status-indicator status-warning';
                dbStatus.innerHTML = '<span class="status-indicator status-warning"></span>Not Ready';
            }
            
            // Update model status
            const modelStatus = document.getElementById('model-status');
            const modelIndicator = modelStatus.querySelector('.status-indicator');
            if (data.model && data.model.model_id !== 'unknown') {
                modelIndicator.className = 'status-indicator status-online';
                modelStatus.innerHTML = '<span class="status-indicator status-online"></span>Loaded';
            } else {
                modelIndicator.className = 'status-indicator status-warning';
                modelStatus.innerHTML = '<span class="status-indicator status-warning"></span>Loading...';
            }
            
            // Update memory status
            const memoryStatus = document.getElementById('memory-status');
            const memoryIndicator = memoryStatus.querySelector('.status-indicator');
            if (data.system && data.system.memory_percent) {
                const memPercent = data.system.memory_percent;
                if (memPercent < 80) {
                    memoryIndicator.className = 'status-indicator status-online';
                } else if (memPercent < 90) {
                    memoryIndicator.className = 'status-indicator status-warning';
                } else {
                    memoryIndicator.className = 'status-indicator status-error';
                }
                memoryStatus.innerHTML = `<span class="${memoryIndicator.className}"></span>${memPercent}% Used`;
            }
        }
        
        // Upload progress simulation
        document.addEventListener('htmx:beforeRequest', function(event) {
            if (event.detail.target.id === 'upload-output') {
                const progressBar = document.getElementById('upload-progress');
                const progressText = progressBar.querySelector('.progress-text');
                let progress = 0;
                
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 95) progress = 95;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                }, 300);
                
                document.addEventListener('htmx:afterRequest', function clearProgress() {
                    clearInterval(interval);
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressText.textContent = '0%';
                    }, 1000);
                    document.removeEventListener('htmx:afterRequest', clearProgress);
                }, { once: true });
            }
        });
        
        // Enhanced response formatting
        document.addEventListener('htmx:afterRequest', function(event) {
            const target = event.detail.target;
            
            // Format ask responses
            if (target.id === 'answer-output') {
                try {
                    const responseText = target.textContent;
                    const jsonData = JSON.parse(responseText);
                    
                    if (jsonData.answer) {
                        let formatted = `‚îå‚îÄ QUERY RESPONSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
                        formatted += `‚îÇ Q: ${document.getElementById('question').value.substring(0, 60)}...\n`;
                        formatted += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;
                        formatted += `${jsonData.answer}\n\n`;
                        
                        if (jsonData.sources && jsonData.sources.length > 0) {
                            formatted += `‚îå‚îÄ DOCUMENT SOURCES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
                            jsonData.sources.forEach((source, i) => {
                                formatted += `‚îÇ [${i+1}] ${source}\n`;
                            });
                            formatted += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;
                        }
                        
                        if (jsonData.metadata) {
                            formatted += `‚îå‚îÄ PROCESSING METADATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
                            formatted += `‚îÇ Response Time: ${jsonData.metadata.processing_time}s\n`;
                            formatted += `‚îÇ Model: ${jsonData.metadata.model}\n`;
                            formatted += `‚îÇ Retrieved Docs: ${jsonData.retrieved_documents || 0}\n`;
                            if (jsonData.metadata.reasoning_steps) {
                                formatted += `‚îÇ Reasoning Steps:\n`;
                                jsonData.metadata.reasoning_steps.forEach(step => {
                                    formatted += `‚îÇ   ‚Ä¢ ${step}\n`;
                                });
                            }
                            formatted += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`;
                        }
                        
                        target.textContent = formatted;
                    } else if (jsonData.error) {
                        target.textContent = `ERROR: ${jsonData.error}`;
                    }
                } catch (e) {
                    // If not JSON, leave as is
                }
            }
            
            // Format search responses
            if (target.id === 'search-output') {
                try {
                    const responseText = target.textContent;
                    const jsonData = JSON.parse(responseText);
                    
                    if (jsonData.results) {
                        let formatted = `‚îå‚îÄ SEARCH RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
                        formatted += `‚îÇ Query: "${jsonData.query}"\n`;
                        formatted += `‚îÇ Found: ${jsonData.total_found} documents\n`;
                        formatted += `‚îÇ Processing Time: ${jsonData.processing_time}s\n`;
                        formatted += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;
                        
                        if (jsonData.results.length > 0) {
                            jsonData.results.forEach((result, i) => {
                                formatted += `‚ñ∂ DOCUMENT ${i + 1} (Relevance: ${(result.relevance_score * 100).toFixed(1)}%)\n`;
                                formatted += `${result.content}\n`;
                                if (result.metadata) {
                                    formatted += `[Length: ${result.metadata.length} chars, Tokens: ~${result.metadata.estimated_tokens}]\n`;
                                }
                                formatted += `${'‚îÄ'.repeat(50)}\n`;
                            });
                        } else {
                            formatted += `No documents found matching your query.\n`;
                        }
                        
                        target.textContent = formatted;
                    } else if (jsonData.error) {
                        target.textContent = `SEARCH ERROR: ${jsonData.error}`;
                    }
                } catch (e) {
                    // If not JSON, leave as is
                }
            }
            
            // Format upload responses
            if (target.id === 'upload-output') {
                try {
                    const responseText = target.textContent;
                    const jsonData = JSON.parse(responseText);
                    
                    if (jsonData.processing_info) {
                        const info = jsonData.processing_info;
                        let formatted = `‚îå‚îÄ UPLOAD RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
                        formatted += `‚îÇ File: ${info.original_filename}\n`;
                        formatted += `‚îÇ Size: ${info.file_size_mb} MB\n`;
                        formatted += `‚îÇ Status: ${info.processing_status.toUpperCase()}\n`;
                        formatted += `‚îÇ Processing Time: ${info.processing_time}s\n`;
                        formatted += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;
                        
                        formatted += `MESSAGE: ${jsonData.message}\n\n`;
                        
                        if (info.vector_db_status) {
                            formatted += `Vector DB Integration: ${info.vector_db_status.toUpperCase()}\n`;
                        }
                        
                        if (info.content_preview) {
                            formatted += `\nCONTENT PREVIEW:\n${info.content_preview.substring(0, 200)}...\n`;
                        }
                        
                        if (jsonData.recommendations) {
                            formatted += `\nRECOMMENDATIONS:\n`;
                            jsonData.recommendations.forEach(rec => {
                                formatted += `‚Ä¢ ${rec}\n`;
                            });
                        }
                        
                        target.textContent = formatted;
                    } else if (jsonData.error) {
                        target.textContent = `UPLOAD ERROR: ${jsonData.error}`;
                    }
                } catch (e) {
                    // If not JSON, leave as is
                }
            }
            
            // Format status responses for output area
            if (target.id === 'status-output') {
                try {
                    const responseText = target.textContent;
                    const jsonData = JSON.parse(responseText);
                    
                    let formatted = `‚îå‚îÄ SYSTEM STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
                    formatted += `‚îÇ Status: ${jsonData.status?.toUpperCase() || 'UNKNOWN'}\n`;
                    formatted += `‚îÇ Version: ${jsonData.version || 'Unknown'}\n`;
                    formatted += `‚îÇ Timestamp: ${new Date(jsonData.timestamp * 1000).toLocaleString()}\n`;
                    formatted += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;
                    
                    if (jsonData.system) {
                        formatted += `üíª SYSTEM INFO:\n`;
                        formatted += `  Platform: ${jsonData.system.platform || 'Unknown'}\n`;
                        formatted += `  Python: ${jsonData.system.python_version || 'Unknown'}\n`;
                        formatted += `  CPU Cores: ${jsonData.system.cpu_count || 'Unknown'}\n`;
                        if (jsonData.system.memory_percent) {
                            formatted += `  Memory: ${jsonData.system.memory_percent}% used (${jsonData.system.memory_available_gb}GB available)\n`;
                        }
                        formatted += `\n`;
                    }
                    
                    if (jsonData.database) {
                        formatted += `üóÑÔ∏è VECTOR DATABASE:\n`;
                        formatted += `  Status: ${jsonData.database.status?.toUpperCase() || 'UNKNOWN'}\n`;
                        formatted += `  Documents: ${jsonData.database.estimated_docs || 0}\n`;
                        formatted += `  Size: ${jsonData.database.size_mb || 0} MB\n`;
                        formatted += `  Path: ${jsonData.database.path || 'Unknown'}\n`;
                        formatted += `\n`;
                    }
                    
                    if (jsonData.model) {
                        formatted += `üß† AI MODEL:\n`;
                        formatted += `  Model ID: ${jsonData.model.model_id || 'Unknown'}\n`;
                        formatted += `  Embedding Model: ${jsonData.model.embedding_model || 'Unknown'}\n`;
                        formatted += `  Max Tokens: ${jsonData.model.max_tokens || 'Unknown'}\n`;
                        formatted += `  Device: ${jsonData.model.device || 'Unknown'}\n`;
                        formatted += `\n`;
                    }
                    
                    if (jsonData.api_metrics) {
                        formatted += `üìä API METRICS:\n`;
                        formatted += `  Total Requests: ${jsonData.api_metrics.requests_total || 0}\n`;
                        formatted += `  Failed Requests: ${jsonData.api_metrics.requests_failed || 0}\n`;
                        formatted += `  Success Rate: ${jsonData.api_metrics.success_rate || 0}%\n`;
                        formatted += `  Avg Response Time: ${jsonData.api_metrics.average_response_time || 0}s\n`;
                        formatted += `  Circuit Breaker: ${jsonData.api_metrics.circuit_breaker_open ? 'OPEN' : 'CLOSED'}\n`;
                    }
                    
                    target.textContent = formatted;
                    
                    // Update diagnostic cards
                    updateDiagnosticCards(jsonData);
                } catch (e) {
                    // If not JSON, leave as is
                }
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter to submit question
            if (e.ctrlKey && e.key === 'Enter') {
                const questionField = document.getElementById('question');
                if (document.activeElement === questionField) {
                    htmx.trigger(document.querySelector('[hx-post="/ask"]'), 'click');
                }
            }
            
            // Alt+1-4 for mode switching
            if (e.altKey && e.key >= '1' && e.key <= '4') {
                e.preventDefault();
                const modes = ['ask', 'search', 'upload', 'diagnostics'];
                switchMode(modes[parseInt(e.key) - 1]);
            }
        });
        
        // Auto-refresh diagnostics every 30 seconds
        setInterval(() => {
            if (document.getElementById('diagnostics-panel').classList.contains('active')) {
                autoRefreshDiagnostics();
            }
        }, 30000);
        
        // Initialize diagnostics on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Clear all inputs
            document.getElementById('question').value = '';
            document.getElementById('search-query').value = '';
            console.log('PyNucleus Developer Console initialized');
        });
    </script>
</body>
</html> 